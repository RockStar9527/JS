# 会话控制 

## 一、会话控制介绍

### 1.1、什么是会话？

> 生活中的会话指的是人与人的对话；而这里的会话指的是浏览器与服务器之间的一次通讯。

### 1.2、什么是会话控制？

> <font color=red>HTTP协议是一个无状态的协议，它无法区分多次请求是否发送自同一客户端。</font>也就是说用户的每一次请求对于服务器而言都是全新的，服务器不知道用户上一次做了什么。
>
> 我们在实际的项目开发中，有大量对会话过程进行跟踪的需求，解决该需求的手段我们称其为会话控制！
>
> <font color=red>实现会话控制的技术手段：cookie和session</font>

### 1.3、为什么要有会话控制？

> 通过会话控制可以实现交互式web应用程序。

## 二、cookie

### 2.1、cookie是什么

> cookie是一个非常具体的东西，其本质是存储在浏览器中的一种数据。也可以说cookie是一个头（请求头/响应头）。工作原理如下：
>
> 1、cookie由服务器生成，然后以响应头的形式发送给浏览器
>
> 2、浏览器收到以后会自动将Cookie保存
>
> 3、浏览器再次访问服务器时，会以请求头的形式将Cookie发回
>
> 4、服务器就可以通过检查浏览器发回的Cookie来识别出不同的浏览器

### 2.2、cookie的不足

> * 各个浏览器对cookie的数量和大小都有不同的限制。所以在使用cookie时，最重要的就是要控制cookie的大小，不要放入无用的信息，也不要放入过多信息。 一般浏览器最多可以保存300个cookie，每个域名下最多20个Cookie（实际上一般浏览器现在都比这个多，如Firefox是50个），而每个cookie的大小为最多`4kb`。
>
> * cookie是由服务器发送给浏览器，再由浏览器将cookie发回，如果cookie较大会导致发送速度非常慢，降低用户的体验。

### 2.3、cookie的使用

>  cookie的内容主要包括：名字，值，过期时间，路径和域。路径与域一起构成cookie的作用范围。若不设置过期时间，则表示这个cookie的生命期为浏览器会话期间，关闭浏览器窗口，cookie就消失。这种生命期为浏览器会话期的cookie被称为会话cookie。会话cookie一般不存储在硬盘上而是保存在内存里，当然这种行为并不是规范规定的。若设置了过期时间，浏览器就会把cookie保存到硬盘上，关闭后再次打开浏览器，这些cookie仍然有效直到超过设定的过期时间。

#### 2.3.1、不使用中间件

> * 创建cookie
>
>   ```js
>   // 生成UTC时间
>   function getUtcTime(s=10) {
>       const date = new Date();
>       date.setTime(Date.now()+s*1000);
>       return date.toUTCString();
>   }
>   // 设置COOKIE
>   app.get("/setCookie",function (req,res) {
>       // 设置一个cookie的方法： 如果多个set,后者会将前者覆盖
>       // res.set("Set-Cookie","userName=zhangsan");
>       // res.set("Set-Cookie","age=12");
>   
>       // 设置多个COOKIE,需要交第二个参数设置为数组，数组中的每一个元素即是对一个COOKIE的说明
>       // 如果不设置过期时间 ，那么关闭浏览器，cookie会消息。这种不设置过期时间的COOKIE称为会话COOKIE
>       // res.set("Set-Cookie",[
>       //     "userName=zhangsan",
>       //     "age=18",
>       // ])
>   
>       // 其它的配置项
>       res.set("Set-Cookie",[
>           //max-age:单位为秒，指定多少秒以后cookie消失。  userName是名字，lisi为值。
>           "userName=lisi;max-age=10",
>           // expires:指定cookie具体过期的时间。
>           `age=12;expires=${getUtcTime(60)}`,
>           // 设置max-age与expires同时设置听谁的？听max-age的。
>           `hobby=study;max-age=60;expires=${getUtcTime(10)}`,
>           // path默认值为/,如果将其设置为/abc,那么只允许在 /abc目录后获得cookie
>           // http://127.0.0.1/abc/a  可以获得address
>           // http://127.0.0.1/abc 可以获得address
>           // http://127.0.0.1/abc/a/b 可以获得address
>           // http://127.0.0.1 不可以获得address
>           // http://127.0.0.1/d 不可以获得address
>           `address=shanghai;max-age=6000;path=/abc`,
>           // domain:zhangpeiyue.com
>           // C:\Windows\System32\drivers\etc
>           `sex=1;max-age=6000;domain=.api.zhangpeiyue.com`,
>           // httpOnly:是一个布尔值，开启后前端无法通过 JS 操作
>           `httpId=1000;max-age=6000;httpOnly=true`
>       ])
>       res.send("设置成功")
>   })
>   ```
>
> * 获得cookie
>
>   ```js
>   // 获得COOKIE
>   app.get("/getCookie",function (req,res) {
>       // 接收请求头当中的cookie。
>       console.log(req.headers.cookie);
>       if(req.headers.cookie){
>        // 将userName=zhangsan; age=18------》对象{ userName: 'zhangsan', age: '18' }
>           const arr = req.headers.cookie.split("; ");
>           let obj = {};
>           arr.forEach(item=>{
>               let arr2 = item.split("=");
>               obj[arr2[0]]=arr2[1];
>           })
>           console.log(obj.userName);// zhangsan
>           console.log(obj.age);// 18
>       }
>   
>       res.send("获取成功")
>   })
>   ```
>
> * 删除cookie
>
>   ```js
>   // 删除COOKIE，将max-age设置为0
>   app.get("/delCookie",function (req,res) {
>       res.set("Set-Cookie",[
>           //max-age:单位为秒，指定多少秒以后cookie消失。  userName是名字，lisi为值。
>           "userName=lisi;max-age=0",
>           // expires:指定cookie具体过期的时间。
>           `age=12;expires=${getUtcTime(60)};max-age=0`,
>           // 设置max-age与expires同时设置听谁的？听max-age的。
>           `hobby=study;max-age=0;expires=${getUtcTime(10)}`,
>           // path默认值为/,如果将其设置为/abc,那么只允许在 /abc目录后获得cookie
>           // http://127.0.0.1/abc/a  可以获得address
>           // http://127.0.0.1/abc 可以获得address
>           // http://127.0.0.1/abc/a/b 可以获得address
>           // http://127.0.0.1 不可以获得address
>           // http://127.0.0.1/d 不可以获得address
>           `address=shanghai;max-age=0;path=/abc`,
>           // domain:zhangpeiyue.com
>           // C:\Windows\System32\drivers\etc
>           `sex=1;max-age=0;domain=.api.zhangpeiyue.com`,
>           // httpOnly:是一个布尔值，开启后前端无法通过 JS 操作
>           `httpId=1000;max-age=0;httpOnly=true`
>       ])
>       res.send("删除成功")
>   })
>   ```
>
> * 前端获得cookie
>
>   ```js
>   document.cookie
>   ```

#### 2.3.1、使用中间件

> 通过配置cookie-parser中间件，可以将cookie解析为一个对象，并且添加为req的cookies属性，使用步骤：
>
> 1) 下载安装
>
> ```shell
> npm i cookie-parser --save
> ```
>
> 2) 引入
>
> ```js
> var cookieParser = require("cookie-parser");
> ```
>
> 3) 设置为中间件
>
> ```js
> app.use(cookieParser());
> ```
>
> 4) 创建Cookie
>
> ```js
> app.get("/setCookie", function (req, res) {
>     res.cookie("username", "sunwukong", {
>         maxAge: 15000,
>         // path:"/abc"
>     });
>     //设置一个有效期为1天的cookie  1000*60*60*24
>     res.cookie("age", 13, {maxAge: 1000 * 60 * 60 * 24});
>     res.send("设置成功")
> })
> ```
>
> 5) 删除Cookie
>
> ```js
> app.get("/delCookie",function (req,res) {
>     //可以通过通过使用一个立即失效的cookie来替换cookie的形式来删除cookie
>     res.cookie("username","11",{maxAge:0});
>     //用来删除一个cookie
>     res.clearCookie("age");// 用来删除一个指定cookie
>     res.send("删除成功");
> })
> ```
>
> 6）获取cookie
>
> ```js
> app.get("/getCookie", function (req, res) {
>     console.log(req.cookies.age);// sumwukong
>     console.log(req.cookies.username);// sunwukong
>     res.send("获得成功")
> })
> ```
>
> 

## 三、session

### 3.1、session是什么

> Session是由服务端提供的数据。数据有可能保存在内存，文件，数据库。
>
> Session 是一个对象，存储特定用户会话所需的属性及配置信息。Session是保存在服务器端的数据.（保存介质， 文件、数据库、内存）

### 3.2、session运作流程

> 我们可以在服务器中为每一次会话创建一个对象，然后每个对象都设置一个唯一的id，并将该id以cookie的形式发送给浏览器，然后将会话中产生的数据统一保存到这个对象中，这样我们就可以将用户的数据全都保存到服务器中，而不需要保存到客户端，客户端只需要保存一个id即可。

### 3.3、session的使用

> 1) 下载安装
>
> ```shell
> npm i express-session --save
> ```
>
> 2) 引入模块
>
> ```js
> var session = require("express-session");
> ```
>
> 3) 设置为中间件
>
> ```js
> app.use(session({
>      name: 'id22',  // 设置cookie的name，默认值是：connect.sid
>      secret: 'atguigu', // 参与加密的字符串（又称签名）
>      saveUninitialized: false, //是否为每次请求都设置一个cookie用来存储session的id
>      resave: true ,// 强制保存 session 即使它并没有变化,。默认为 true。建议设置成 false。
>      cookie: {
>          httpOnly: true, // 开启后前端无法通过 JS 操作
>          maxAge: 1000*30 // 这一条 是控制 sessionID 的过期时间的！！！
>      }
> }));
> ```

### 3.4、cookie 和 session的区别

> 1) 存在的位置：
>
> cookie 存在于客户端
>
> session 存在于服务器端，一个session域对象为一个用户浏览器服务
>
> 2) 安全性： 
>
> cookie是以明文的方式存放在客户端的，安全性较低，可以通过一个加密算法进行加密后存放
>
> session存放于服务器中，所以安全性较好
>
> 3) 网络传输量：
>
> cookie会传递消息给服务器
>
> session本身存放于服务器，但是通过cookie传递id，会有少量的传送流量
>
> 4) 大小：
>
> cookie 保存的数据不能超过`4K`，很多浏览器都限制一个站点最多保存50个cookie
>
> session 保存数据理论上没有任何限制

## 四、Token

> 通过token可以解决跨域会话控制的问题。

